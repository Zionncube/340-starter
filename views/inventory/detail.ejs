<%- include('../partials/head') %>
<%- include('../partials/header') %>
<%- include('../partials/nav') %>
<main>
  <!-- DEBUG INFO - Remove after testing -->
  <div style="background: #f0f0f0; padding: 10px; margin: 10px; border: 1px solid #ccc;">
    <strong>Debug Info:</strong><br>
    Account Data: <%= locals.accountData ? 'LOGGED IN as ' + locals.accountData.account_firstname : 'NOT LOGGED IN' %><br>
    Logged In Status: <%= locals.loggedin ? 'YES' : 'NO' %>
  </div>

  <% if (locals.message) { %>
    <div class="flash-message"><%= message %></div>
  <% } %>
  
  <%- grid %>
  
  <!-- Reviews Section -->
  <section class="reviews-section">
    <div class="reviews-header">
      <h2>Customer Reviews</h2>
      
      <!-- THIS IS THE MISSING REVIEW BUTTON CODE! -->
      <% if (locals.accountData) { %>
        <a href="/reviews/add/<%= vehicle.inv_id %>" class="add-review-btn">✍️ Write a Review</a>
      <% } else { %>
        <p class="login-prompt">
          <a href="/account/login">Login</a> to write a review
        </p>
      <% } %>
    </div>
    
    <!-- Show existing reviews (none yet) -->
    <% if (locals.reviews && reviews.length > 0) { %>
      <div class="reviews-list">
        <% reviews.forEach(review => { %>
          <div class="review-item">
            <div class="review-header">
              <span class="reviewer-name"><%= review.account_firstname %> <%= review.account_lastname %></span>
              <span class="review-rating">
                <% for(let i = 1; i <= 5; i++) { %>
                  <%= i <= review.review_rating ? '⭐' : '☆' %>
                <% } %>
              </span>
              <span class="review-date"><%= new Date(review.review_date).toLocaleDateString() %></span>
            </div>
            <h4><%= review.review_title %></h4>
            <p><%= review.review_text %></p>
          </div>
        <% }) %>
      </div>
    <% } else { %>
      <div class="no-reviews">
        <p>No reviews yet. Be the first to review this vehicle!</p>
        <% if (!locals.accountData) { %>
          <p><a href="/account/register">Create an account</a> to leave a review.</p>
        <% } %>
      </div>
    <% } %>
  </section>
</main>
<%- include('../partials/footer') %>